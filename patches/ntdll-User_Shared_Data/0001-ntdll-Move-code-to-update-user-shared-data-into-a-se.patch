From cfc04e8d11f8ed0cc7a7a0097c0ae888f1222f92 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Wed, 26 Nov 2014 10:46:09 +0100
Subject: [PATCH] ntdll: Move code to update user shared data into a separate
 function.

---
 dlls/ntdll/ntdll.spec |  3 +++
 dlls/ntdll/thread.c   | 28 +++++++++++++++++++++-------
 2 files changed, 24 insertions(+), 7 deletions(-)

diff --git a/dlls/ntdll/ntdll.spec b/dlls/ntdll/ntdll.spec
index c50e83b5aa7..97cb16d4c3a 100644
--- a/dlls/ntdll/ntdll.spec
+++ b/dlls/ntdll/ntdll.spec
@@ -1591,3 +1591,6 @@
 # Filesystem
 @ cdecl wine_nt_to_unix_file_name(ptr ptr long long)
 @ cdecl wine_unix_to_nt_file_name(ptr ptr)
+
+# User shared data
+@ cdecl __wine_user_shared_data()
diff --git a/dlls/ntdll/thread.c b/dlls/ntdll/thread.c
index 78c18bc2d84..cd9cd1b9754 100644
--- a/dlls/ntdll/thread.c
+++ b/dlls/ntdll/thread.c
@@ -275,7 +275,6 @@ TEB *thread_init(void)
     TEB *teb;
     void *addr;
     SIZE_T size;
-    LARGE_INTEGER now;
     NTSTATUS status;
     struct ntdll_thread_data *thread_data;
 
@@ -351,7 +350,26 @@ TEB *thread_init(void)
     init_paths();
     set_process_name( __wine_main_argc, __wine_main_argv );
 
-    /* initialize time values in user_shared_data */
+	/* initialize user_shared_data */
+    __wine_user_shared_data();
+    fill_cpu_info();
+
+    virtual_get_system_info( &sbi );
+    user_shared_data->NumberOfPhysicalPages = sbi.MmNumberOfPhysicalPages;
+
+    return teb;
+}
+
+
+
+/**************************************************************************
+ *  __wine_user_shared_data   (NTDLL.@)
+ *
+ * Update user shared data and return the address of the structure.
+ */
+BYTE* CDECL __wine_user_shared_data(void)
+{
+    LARGE_INTEGER now;
     NtQuerySystemTime( &now );
     user_shared_data->SystemTime.LowPart = now.u.LowPart;
     user_shared_data->SystemTime.High1Time = user_shared_data->SystemTime.High2Time = now.u.HighPart;
@@ -359,12 +377,8 @@ TEB *thread_init(void)
     user_shared_data->u.TickCount.High2Time = user_shared_data->u.TickCount.High1Time;
     user_shared_data->TickCountLowDeprecated = user_shared_data->u.TickCount.LowPart;
     user_shared_data->TickCountMultiplier = 1 << 24;
-    fill_cpu_info();
 
-    virtual_get_system_info( &sbi );
-    user_shared_data->NumberOfPhysicalPages = sbi.MmNumberOfPhysicalPages;
-
-    return teb;
+    return (BYTE *)user_shared_data;
 }
 
 BOOL read_process_memory_stats(int unix_pid, VM_COUNTERS *pvmi)
-- 
2.26.2

