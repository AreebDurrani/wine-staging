From e2f505d4c63dde39dbbcc215a7801020b04e3c25 Mon Sep 17 00:00:00 2001
From: Zebediah Figura <z.figura12@gmail.com>
Date: Mon, 6 Aug 2018 21:32:56 -0500
Subject: [PATCH] ntdll: Don't call LdrQueryProcessModuleInformation in
 NtQuerySystemInformation(SystemModuleInformation).

Based on a patch by Andrew Wesie.

This is simply incorrect; this function should only list kernel drivers.

This makes the anticheat engine in League of Legends 8.15+ happy.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=45550
---
 dlls/ntdll/unix/system.c | 19 ++++++++++++++++---
 1 file changed, 16 insertions(+), 3 deletions(-)

diff --git a/dlls/ntdll/unix/system.c b/dlls/ntdll/unix/system.c
index 68de16b7e5b..a57b040c533 100644
--- a/dlls/ntdll/unix/system.c
+++ b/dlls/ntdll/unix/system.c
@@ -1930,9 +1930,22 @@ NTSTATUS WINAPI NtQuerySystemInformation( SYSTEM_INFORMATION_CLASS class,
     }
 
     case SystemModuleInformation:
-        /* FIXME: should be system-wide */
-        if (!info) ret = STATUS_ACCESS_VIOLATION;
-        else ret = LdrQueryProcessModuleInformation( info, size, &len );
+        if (!info)
+            ret = STATUS_ACCESS_VIOLATION;
+        else if (size < FIELD_OFFSET( SYSTEM_MODULE_INFORMATION, Modules[1] ))
+        {
+            len = FIELD_OFFSET( SYSTEM_MODULE_INFORMATION, Modules[1] );
+            ret = STATUS_INFO_LENGTH_MISMATCH;
+        }
+        else
+        {
+            SYSTEM_MODULE_INFORMATION *smi = info;
+
+            FIXME("returning fake driver list\n");
+            smi->ModulesCount = 1;
+            memset(&smi->Modules[0], 0, sizeof(smi->Modules[0]));
+            ret = STATUS_SUCCESS;
+        }
         break;
 
     case SystemHandleInformation:
-- 
2.27.0

